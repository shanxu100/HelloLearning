# 网络穿透——NAT网络穿透
参考：  
[《NAT穿透》](https://zhuanlan.zhihu.com/p/86759357)  
[《Socket——NAT穿透解决方案：UDP打洞》](https://www.cnblogs.com/tingguoguoyo/p/10955488.html)  
[《WebRTC 简介》](https://www.beikejiedeliulangmao.top/webrtc/introduction/)  
[《P2P技术详解(一)：NAT详解——详细原理、P2P简介》](http://www.52im.net/thread-50-1-1.html)  

## 1、NAT技术

在理论上，具有IP地址的每个站点是平等的，即**在协议层面有相当的获取服务和提供服务的能力**，不同的IP地址之间没有差异。也就是说，每个站点既可以做Server可以做Client。在网络层和传输层没有差异，只是在应用层做了区分而已。所以**IP协议栈天生具有端到端通信的能力**。
NAT，即网络地址转换 (Network Address Translation)，是一种在IP数据包通过路由器或防火墙时重写来源IP地址或目的IP地址的技术，也就是说将内部的**私有IP地址（private IP）**转换成可以在公网使用的**公网IP（public IP）**。  
NAT技术在一定程度上解决了IPv4地址短缺问题，为互联网的普及和发展做出了贡献。但是，**NAT又破坏了IP协议栈的平等性：每个通话只能由单方面发起，使依赖IP进行通信的机制都失效了**。所以IP协议栈的通信能力受到了一定的限制。  
NAT协议栈的核心思想为：路由器具备公用 IP 地址，而连上路由器的所有装置则具备私有 IP 地址，使用NAT技术可以使多台设备只通过一个公有IP地址访问因特网，而不用每一个设备分配一个公有IP地址。

补充：  
私有IP地址是一段保留的IP地址。只是使用在局域网中，在Internet上是不使用的。私有IP地址的范围有：   
- ```10.0.0.0-10.255.255.255 ```  
- ```172.16.0.0—172.31.255.255```   
- ```192.168.0.0-192.168.255.255```   


## 2、NAT网络的分类
- 内网地址——iAddr:iPort
- 外部地址——eAddr:ePort
- 目标地址——tAddr:tPort
- any——任意IP或端口

### 2.1 完全锥型——Full-Cone NAT或one-to-one NAT
- 出：  
  一旦一个内网地址 (iAddr:iPort) 被映射到一个外部地址 (eAddr:ePort), 来自 iAddr:iPort 的任何数据包将通过 eAddr:ePort 发送。
- 入：  
  任何外部主机(any:any)能够通过eAddr:ePort这个内网地址(iAddr:iPort)发送数据包到iAddr:iPort。

### 2.2 受限锥型——(Address) Restricted-Cone NAT
- 出：  
  一旦一个内网地址 (iAddr:iPort) 被映射到一个外部地址 (eAddr:ePort), 来自 iAddr:iPort 的任何数据包将通过 eAddr:ePort 发送。
- 入：  
  只有**内部主机(iAddr:iPort)先通过eAddr:ePort发送数据包到目标地址(tAddr:tPort)**，目标主机通过任何端口(**tAddr:any**)发往eAddr:ePort的数据包才能够被正确的转发到iAddr:iPort。

### 2.3 端口受限锥型——Port Restricted-Cone NAT
类似于address restricted cone NAT, 但是端口号有限制。 
- 出：   
  一旦一个内网地址 (iAddr:iPort) 被映射到一个外部地址 (eAddr:ePort), 来自 iAddr:iPort 的任何数据包将通过 eAddr:ePort 发送。
- 入：   
  只有内部主机(iAddr:iPort)先通过eAddr:ePort发送数据包到目标地址(tAddr:tPort)，目标主机通过相同地址(**tAddr:tPort**)发往eAddr:ePort的数据包才能够被正确的转发到iAddr:iPort。

### 2.4 对称型——Symmentric NAT
- 出：  
  相同内部地址(iAddr:iPort)访问相同目标地址(tAddr:tPort)时，会被映射成唯一的一个外部地址 (eAddr:ePort)；**如果访问不同的目标地址(tAddr:tPort)，就会被重新分配映射地址**。
- 入：  
  只有内部主机(iAddr:iPort)先通过eAddr:ePort发送数据包到目标地址(tAddr:tPort)，目标主机通过相同地址(tAddr:tPort)发往eAddr:ePort的数据包才能够被正确的转发到iAddr:iPort。

## 3、NAT穿透思路与P2P通信原理

P2P通信，可以简单地抽象为两个步骤：
1. 发现自己的公网IP和Port
2. 将自己的IP和Port共享给对方
完成上述两个步骤后，两端就可以进行直接通信。    
**ICE，交互式连接创建（Interactive Connectivity Establishment）**，是由IETF的MMUSIC工作组开发出来的一种综合性的框架framework，可集成各种NAT穿透技术，如STUN、TURN（Traversal Using Relay NAT，中继NAT实现的穿透）、RSIP（Realm Specific IP，特定域IP）等。该framework可以让SIP的客户端利用各种NAT穿透方式打穿远程的防火墙。  
由上一小节可知，因为NAT的类型不一样，所以打洞原理不一样，不同NAT之间的穿透成功率也就不一样。

### 3.1 方式一（仅适用于前三种NAT类型）：
1. Client1从源private地址(iAddr:iPort)访问打洞服务器Server
2. 打洞服务器Server将Client1的public地址(eAddr:ePort)返回给Client1
3. Client2使用同样的方式获取其自己的public地址
4. Client1和Client2通过控制服务器Control获得对方的public地址(eAddr:ePort)
5. 对于第二种和第三种NAT，Client1和Client2先向对方的public地址(eAddr:ePort)发送一个数据包。对于第一种NAT，无此步骤。
6. Client向对方的public地址(eAddr:ePort)发送数据，实现双方自由通信

### 3.2 方式二（适用于所有NAT类型）：




## 4、探针技术——STUN协议
STUN（Simple Traversal of User Datagram Protocol Through Network Address Translators，简单的用UDP穿透NAT）协议为终端提供一种方式：能够获知自己经过NAT映射后的地址，从而替代位于应用层中的私网地址，达到NAT穿透的目的。
### 4.1 过程
典型的运用STUN进行NAT穿透的场景：
1. Client首先向位于公网上的STUN服务器发送Binding Request消息;
2. STUN Server接收到请求消息后识别出经过NAT转换后的公网地址 eAddress:ePort;
3. STUN Server将公网地址附加在Binding Response消息中返回给Client。

### 4.2 约束
1. 使用STUN进行NAT穿透对应用的要求是**必须使用同样的端口**与STUN服务器交互和进行应用层P2P通讯。比如当希望使用端口 37000进行RTP包的NAT穿透时，必须同样使用37000端口与STUN服务器通讯，否则从STUN 服务器获得的NAT映射后的地址一般与实际地址时不一样的。

2. 另一个要求是STUN客户端与服务器端的通讯和应用使用获得的NAT映射地址进行应用层通讯**在时间上必须有连贯性**。换句话说，这次通过STUN服务器获取的Public地址，不能在下次建立P2P通信时直接使用，需要重新从STUN获取一次。这源于NAT设备建立的绑定有生存时间，当原绑定消亡后，NAT设备为同一个私网地址建立的新绑定往往不同，因此转换后的公网地址是不同的。

### 4.3 局限性
**无法应用于“对称型NAT”。**

## 5、探针技术——TURN协议
TURN协议（Traversal Using Relays around NAT，使用中继穿透NAT）。核心思想就是**通过两方通讯的“中间人”方式实现穿透。**
### 5.1 过程
1. Client首先向位于公网上的TURN Server发送Request消息;
2. TURN Server接收到请求消息后分配一个位于TURN Server上的代理public地址 pAddress:pPort;
3. STUN Server将代理public地址附加在Response消息中返回给Client。
4. 两个Client通过同样的方式获取代理public地址，然后使用TURN Server作为中继，转发双方的数据，进行通信。
### 5.2 局限性
用户发出的报文都要经过TURN服务器进行转发，此时不再是真正意义上的P2P通信。TURN中继服务会成为通信瓶颈。


补充：
STUN/TURN协议的一种实现：coturn服务器

## 6、RSIP

特定协议的自穿越技术
IKE和IPsec


